# main.py
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    ContextTypes, MessageHandler, filters
)
import config
from database import Database
from game_logic import GameLogic

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
db = Database()
game_logic = GameLogic()

# –ö–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ä—Ç
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    db_user = db.get_user(user.id, user.username)
    
    welcome_text = (
        f"üè∞ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ, {user.first_name}!\n\n"
        "–¢—ã –Ω–∞—á–∏–Ω–∞–µ—à—å –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π –∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω, –Ω–æ –º–æ–∂–µ—à—å —Å—Ç–∞—Ç—å –≤–µ–ª–∏–∫–∏–º –ª–æ—Ä–¥–æ–º!\n"
        "–†–∞–∑–≤–∏–≤–∞–π —Ñ–µ—Ä–º—É, –Ω–∞–Ω–∏–º–∞–π –≤–æ–π—Å–∫–∞ –∏ —Å—Ä–∞–∂–∞–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏.\n\n"
        "üìú –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/profile - –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å\n"
        "/farm - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–µ—Ä–º–æ–π\n"
        "/troops - –¢–≤–æ–∏ –≤–æ–π—Å–∫–∞\n"
        "/recruit - –ù–∞–Ω—è—Ç—å –≤–æ–π—Å–∫–∞\n"
        "/attack - –ê—Ç–∞–∫–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞\n"
        "/market - –†—ã–Ω–æ–∫ (–æ–±–º–µ–Ω —Ä–µ—Å—É—Ä—Å–æ–≤)\n"
        "/top - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤\n"
        "/help - –ü–æ–º–æ—â—å"
    )
    
    await update.message.reply_text(welcome_text)

# –ü—Ä–æ—Ñ–∏–ª—å
async def profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    db_user = db.get_user(user.id)
    resources = db.get_resources(user.id)
    troops = db.get_troops(user.id)
    
    gold, food, wood, stone, iron, farm_level = resources
    
    upkeep = game_logic.calculate_upkeep(troops)
    farm_income = db.get_farm_income(user.id)
    
    profile_text = (
        f"üëë –ü—Ä–æ—Ñ–∏–ª—å {user.first_name}\n\n"
        f"üí∞ –ó–æ–ª–æ—Ç–æ: {gold}\n"
        f"üçñ –ï–¥–∞: {food}\n"
        f"ü™µ –î—Ä–µ–≤–µ—Å–∏–Ω–∞: {wood}\n"
        f"ü™® –ö–∞–º–µ–Ω—å: {stone}\n"
        f"‚öíÔ∏è –ñ–µ–ª–µ–∑–æ: {iron}\n\n"
        f"üè° –£—Ä–æ–≤–µ–Ω—å —Ñ–µ—Ä–º—ã: {farm_level}\n"
        f"üìà –î–æ—Ö–æ–¥ —Ñ–µ—Ä–º—ã: {config.FARM_LEVELS[farm_level]['food_production']} –µ–¥—ã/—á–∞—Å\n"
        f"‚è≥ –ù–∞–∫–æ–ø–ª–µ–Ω–æ –µ–¥—ã: {farm_income}\n"
        f"‚öîÔ∏è –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–π—Å–∫: {upkeep} –µ–¥—ã/—á–∞—Å\n\n"
        f"üõ°Ô∏è –í–æ–π—Å–∫–∞:\n"
    )
    
    for unit_type, count in troops.items():
        if count > 0:
            profile_text += f"  {unit_type}: {count}\n"
    
    keyboard = [
        [InlineKeyboardButton("üè° –°–æ–±—Ä–∞—Ç—å —É—Ä–æ–∂–∞–π", callback_data="collect_farm")],
        [InlineKeyboardButton("‚öîÔ∏è –ú–æ–∏ –≤–æ–π—Å–∫–∞", callback_data="view_troops")]
    ]
    
    await update.message.reply_text(
        profile_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–µ—Ä–º–æ–π
async def farm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    resources = db.get_resources(user.id)
    farm_level = resources[5]
    
    farm_text = f"üè° –§–µ—Ä–º–∞ (–£—Ä–æ–≤–µ–Ω—å {farm_level})\n\n"
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
    current_prod = config.FARM_LEVELS[farm_level]['food_production']
    farm_text += f"–¢–µ–∫—É—â–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: {current_prod} –µ–¥—ã/—á–∞—Å\n\n"
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–≤–Ω–µ
    if farm_level < 5:
        next_level = farm_level + 1
        next_cost = config.FARM_LEVELS[next_level]['cost']
        next_prod = config.FARM_LEVELS[next_level]['food_production']
        
        cost_text = "–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è:\n"
        if 'gold' in next_cost:
            cost_text += f"üí∞ –ó–æ–ª–æ—Ç–æ: {next_cost['gold']}\n"
        if 'wood' in next_cost:
            cost_text += f"ü™µ –î—Ä–µ–≤–µ—Å–∏–Ω–∞: {next_cost['wood']}\n"
        if 'stone' in next_cost:
            cost_text += f"ü™® –ö–∞–º–µ–Ω—å: {next_cost['stone']}\n"
        
        farm_text += f"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: +{next_prod} –µ–¥—ã/—á–∞—Å\n{cost_text}"
        
        keyboard = [[InlineKeyboardButton("üìà –£–ª—É—á—à–∏—Ç—å —Ñ–µ—Ä–º—É", callback_data="upgrade_farm")]]
        await update.message.reply_text(
            farm_text,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        farm_text += "‚ú® –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!"
        await update.message.reply_text(farm_text)

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–æ–π—Å–∫
async def troops(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    troops = db.get_troops(user.id)
    resources = db.get_resources(user.id)
    
    if not any(troops.values()):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –≤–æ–π—Å–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /recruit —á—Ç–æ–±—ã –Ω–∞–Ω—è—Ç—å —Å–æ–ª–¥–∞—Ç!")
        return
    
    troops_text = "‚öîÔ∏è –¢–≤–æ—è –∞—Ä–º–∏—è:\n\n"
    total_power = 0
    total_upkeep = 0
    
    for unit_type, count in troops.items():
        if count > 0:
            power = count * config.UNIT_POWER[unit_type]
            upkeep = count * config.UNIT_UPKEEP[unit_type]
            troops_text += f"‚Ä¢ {unit_type}: {count} (‚öîÔ∏è {power} —Å–∏–ª—ã, üçñ {upkeep} –µ–¥—ã/—á–∞—Å)\n"
            total_power += power
            total_upkeep += upkeep
    
    troops_text += f"\nüìä –û–±—â–∞—è —Å–∏–ª–∞: {total_power}\n"
    troops_text += f"üçñ –û–±—â–µ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: {total_upkeep} –µ–¥—ã/—á–∞—Å"
    
    await update.message.reply_text(troops_text)

# –ù–∞–π–º –≤–æ–π—Å–∫
async def recruit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    resources = db.get_resources(user.id)
    
    recruit_text = "üéØ –ù–∞–π–º –≤–æ–π—Å–∫:\n\n"
    
    keyboard = []
    for unit_type, cost in config.UNIT_COSTS.items():
        power = config.UNIT_POWER[unit_type]
        upkeep = config.UNIT_UPKEEP[unit_type]
        
        cost_text = []
        if 'gold' in cost:
            cost_text.append(f"üí∞{cost['gold']}")
        if 'food' in cost:
            cost_text.append(f"üçñ{cost['food']}")
        if 'wood' in cost:
            cost_text.append(f"ü™µ{cost['wood']}")
        if 'stone' in cost:
            cost_text.append(f"ü™®{cost['stone']}")
        if 'iron' in cost:
            cost_text.append(f"‚öíÔ∏è{cost['iron']}")
        
        recruit_text += f"{unit_type}: ‚öîÔ∏è{power} üçñ{upkeep}/—á | {' '.join(cost_text)}\n"
        keyboard.append([InlineKeyboardButton(
            f"–ù–∞–Ω—è—Ç—å {unit_type}", 
            callback_data=f"recruit_{unit_type}"
        )])
    
    await update.message.reply_text(
        recruit_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# –ê—Ç–∞–∫–∞
async def attack(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text(
            "–£–∫–∞–∂–∏—Ç–µ ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∞—Ç–∞–∫–∏!\n"
            "–ü—Ä–∏–º–µ—Ä: /attack 123456789"
        )
        return
    
    try:
        target_id = int(context.args[0])
        attacker_id = update.effective_user.id
        
        if target_id == attacker_id:
            await update.message.reply_text("–ù–µ–ª—å–∑—è –∞—Ç–∞–∫–æ–≤–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!")
            return
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏
        target = db.get_user(target_id)
        if not target:
            await update.message.reply_text("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –≤–æ–π—Å–∫–∞
        attacker_troops = db.get_troops(attacker_id)
        defender_troops = db.get_troops(target_id)
        
        if not any(attacker_troops.values()):
            await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –≤–æ–π—Å–∫ –¥–ª—è –∞—Ç–∞–∫–∏!")
            return
        
        if not any(defender_troops.values()):
            await update.message.reply_text("–£ —Ü–µ–ª–∏ –Ω–µ—Ç –≤–æ–π—Å–∫! –ê—Ç–∞–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
            return
        
        # –°–∏–º—É–ª—è—Ü–∏—è –±–∏—Ç–≤—ã
        result, loot, attacker_losses, defender_losses = game_logic.resolve_battle(
            attacker_troops, defender_troops
        )
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Ç–µ—Ä–∏
        for unit_type, loss in attacker_losses.items():
            db.remove_troops(attacker_id, unit_type, loss)
        
        for unit_type, loss in defender_losses.items():
            db.remove_troops(target_id, unit_type, loss)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º loot –ø—Ä–∏ –ø–æ–±–µ–¥–µ
        if result == "attacker_victory" and loot:
            db.update_resources(attacker_id, **loot)
            # –£–º–µ–Ω—å—à–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã —Ü–µ–ª–∏
            for resource, amount in loot.items():
                db.update_resources(target_id, **{resource: -amount})
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∏—Ç–≤—É
        db.create_battle(
            attacker_id, target_id, result, loot,
            attacker_losses, defender_losses
        )
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = f"‚öîÔ∏è –†–ï–ó–£–õ–¨–¢–ê–¢ –ë–ò–¢–í–´ ‚öîÔ∏è\n\n"
        
        if result == "attacker_victory":
            report += "üèÜ –ü–û–ë–ï–î–ê! –í—ã —Ä–∞–∑–≥—Ä–∞–±–∏–ª–∏ –≤—Ä–∞–≥–∞!\n\n"
            report += f"–¢—Ä–æ—Ñ–µ–∏:\n"
            report += f"üí∞ –ó–æ–ª–æ—Ç–æ: {loot.get('gold', 0)}\n"
            report += f"üçñ –ï–¥–∞: {loot.get('food', 0)}\n"
            report += f"ü™µ –î—Ä–µ–≤–µ—Å–∏–Ω–∞: {loot.get('wood', 0)}\n"
            report += f"ü™® –ö–∞–º–µ–Ω—å: {loot.get('stone', 0)}\n"
        elif result == "defender_victory":
            report += "üíî –ü–û–†–ê–ñ–ï–ù–ò–ï! –í—Ä–∞–≥ –æ—Ç—Ä–∞–∑–∏–ª –∞—Ç–∞–∫—É!\n"
        else:
            report += "ü§ù –ù–ò–ß–¨–Ø! –û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–Ω–µ—Å–ª–∏ –ø–æ—Ç–µ—Ä–∏!\n"
        
        report += f"\n–í–∞—à–∏ –ø–æ—Ç–µ—Ä–∏:\n"
        for unit, loss in attacker_losses.items():
            if loss > 0:
                report += f"‚Ä¢ {unit}: {loss}\n"
        
        report += f"\n–ü–æ—Ç–µ—Ä–∏ –≤—Ä–∞–≥–∞:\n"
        for unit, loss in defender_losses.items():
            if loss > 0:
                report += f"‚Ä¢ {unit}: {loss}\n"
        
        await update.message.reply_text(report)
        
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID!")

# –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤
async def top(update: Update, context: ContextTypes.DEFAULT_TYPE):
    cursor = db.conn.cursor()
    cursor.execute('''
        SELECT username, gold, food, farm_level 
        FROM users 
        ORDER BY gold DESC 
        LIMIT 10
    ''')
    top_players = cursor.fetchall()
    
    top_text = "üèÜ –¢–û–ü-10 –ë–û–ì–ê–¢–ï–ô–®–ò–• –õ–û–†–î–û–í üèÜ\n\n"
    
    for i, (username, gold, food, farm_level) in enumerate(top_players, 1):
        name = username if username else f"–ò–≥—Ä–æ–∫"
        top_text += f"{i}. {name} - üí∞{gold} üçñ{food} (–§–µ—Ä–º–∞ {farm_level})\n"
    
    await update.message.reply_text(top_text)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∫–Ω–æ–ø–æ–∫
async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    data = query.data
    
    if data == "collect_farm":
        food_collected = db.collect_farm(user_id)
        await query.edit_message_text(
            f"üçñ –°–æ–±—Ä–∞–Ω–æ —É—Ä–æ–∂–∞—è: {food_collected} –µ–¥—ã!"
        )
    
    elif data == "upgrade_farm":
        success, message = db.upgrade_farm(user_id)
        await query.edit_message_text(message)
    
    elif data == "view_troops":
        troops = db.get_troops(user_id)
        troops_text = "‚öîÔ∏è –¢–≤–æ–∏ –≤–æ–π—Å–∫–∞:\n"
        for unit, count in troops.items():
            if count > 0:
                troops_text += f"‚Ä¢ {unit}: {count}\n"
        await query.edit_message_text(troops_text)
    
    elif data.startswith("recruit_"):
        unit_type = data.replace("recruit_", "")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø —é–Ω–∏—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        context.user_data['recruiting'] = unit_type
        
        await query.edit_message_text(
            f"–°–∫–æ–ª—å–∫–æ {unit_type} –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–Ω—è—Ç—å?\n"
            f"–ù–∞–ø–∏—à–∏—Ç–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5)"
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –Ω–∞–π–º–∞)
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if 'recruiting' in context.user_data:
        try:
            count = int(update.message.text)
            if count <= 0:
                await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ!")
                return
            
            unit_type = context.user_data['recruiting']
            user_id = update.effective_user.id
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
            resources = db.get_resources(user_id)
            if game_logic.can_afford_troops(resources, unit_type, count):
                cost = config.UNIT_COSTS[unit_type]
                
                # –°–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
                db.update_resources(
                    user_id,
                    gold=-cost.get('gold', 0) * count,
                    food=-cost.get('food', 0) * count,
                    wood=-cost.get('wood', 0) * count,
                    stone=-cost.get('stone', 0) * count,
                    iron=-cost.get('iron', 0) * count
                )
                
                # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–π—Å–∫
                db.add_troops(user_id, unit_type, count)
                
                await update.message.reply_text(
                    f"‚úÖ –í—ã –Ω–∞–Ω—è–ª–∏ {count} {unit_type}!"
                )
            else:
                await update.message.reply_text(
                    "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!"
                )
            
            # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            del context.user_data['recruiting']
            
        except ValueError:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!")

# –ü–æ–º–æ—â—å
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = (
        "üìú –ü–û–ú–û–©–¨ –ü–û –ò–ì–†–ï üìú\n\n"
        "üè∞ –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:\n"
        "/profile - –¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ —Ä–µ—Å—É—Ä—Å—ã\n"
        "/farm - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–µ—Ä–º–æ–π (—Å–±–æ—Ä —É—Ä–æ–∂–∞—è, —É–ª—É—á—à–µ–Ω–∏–µ)\n"
        "/troops - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–µ–π –∞—Ä–º–∏–∏\n"
        "/recruit - –ù–∞–Ω—è—Ç—å –Ω–æ–≤—ã—Ö —Å–æ–ª–¥–∞—Ç\n"
        "/attack [id] - –ê—Ç–∞–∫–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞\n"
        "/top - –¢–æ–ø-10 –±–æ–≥–∞—Ç–µ–π—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤\n"
        "/help - –≠—Ç–æ –º–µ–Ω—é\n\n"
        
        "‚öîÔ∏è –¢–ò–ü–´ –í–û–ô–°–ö:\n"
        "‚Ä¢ spearman - –ö–æ–ø–µ–π—â–∏–∫ (‚öîÔ∏è10, üçñ1/—á)\n"
        "‚Ä¢ swordsman - –ú–µ—á–Ω–∏–∫ (‚öîÔ∏è15, üçñ2/—á)\n"
        "‚Ä¢ archer - –õ—É—á–Ω–∏–∫ (‚öîÔ∏è12, üçñ1/—á)\n"
        "‚Ä¢ knight - –†—ã—Ü–∞—Ä—å (‚öîÔ∏è25, üçñ3/—á)\n"
        "‚Ä¢ catapult - –ö–∞—Ç–∞–ø—É–ª—å—Ç–∞ (‚öîÔ∏è30, üçñ4/—á)\n\n"
        
        "üè° –§–ï–†–ú–ê:\n"
        "–§–µ—Ä–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –µ–¥—É –∫–∞–∂–¥—ã–π —á–∞—Å. "
        "–ï–¥–∞ –Ω—É–∂–Ω–∞ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –≤–æ–π—Å–∫. "
        "–£–ª—É—á—à–∞–π—Ç–µ —Ñ–µ—Ä–º—É –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞!\n\n"
        
        "‚öîÔ∏è –ë–ò–¢–í–´:\n"
        "–ê—Ç–∞–∫—É–π—Ç–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –∏—Ö —Ä–µ—Å—É—Ä—Å—ã. "
        "–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç—Ä–æ—Ñ–µ–∏, –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–π —Ç–µ—Ä—è–µ—Ç –≤–æ–π—Å–∫–∞ –∏ —Ä–µ—Å—É—Ä—Å—ã!"
    )
    
    await update.message.reply_text(help_text)

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(config.BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("profile", profile))
    application.add_handler(CommandHandler("farm", farm))
    application.add_handler(CommandHandler("troops", troops))
    application.add_handler(CommandHandler("recruit", recruit))
    application.add_handler(CommandHandler("attack", attack))
    application.add_handler(CommandHandler("top", top))
    application.add_handler(CommandHandler("help", help_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫
    application.add_handler(CallbackQueryHandler(button_callback))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()